<!DOCTYPE html>
<html>
<head>
  <title>HTML5 drag and drop browser incosistencies</title>
  <link rel="stylesheet" href="drag-and-drop.css" />
  <script>
  (function(){
    var onDragStart = function(e){
      var dragData = this.getAttribute('data-drag-data') || this.textContent;
      var dataType = this.getAttribute('data-type') || 'text';

      if(this.hasAttribute('data-drag-image') && e.dataTransfer.setDragImage) {
        var dragImage = document.querySelector(this.getAttribute('data-drag-image'));
        e.dataTransfer.setDragImage(dragImage, 0, 0);
      };

      e.dataTransfer.setData(dataType, dragData);
    };

    window.addEventListener('DOMContentLoaded', function(){
      var draggables = document.querySelectorAll('[draggable]');
      [].forEach.call(draggables, function(elt){
        elt.addEventListener('dragstart', onDragStart);
      });
    })
  })();
  </script>
</head>
<body>
<h1>HTML 5 drag and drop API</h1>
<p>This article mostly covers browser incosistencies. Tutorials and specs can be found in <a href="#references">references</a> section.</p>

<article>
<h2>Making element draggable</h2>
<p>To make element draggable set <code>draggable</code> attribute to "true". This is not enough for Firefox, though. In firefox you must listen to <code>dragstart</code> event and set some data on <code>DataTransfer</code> object:</p>
<pre><code>
draggableElement.addEventListener('dragstart', function(e){
  e.dataTransfer.setData('text', 'foo');
});
</code></pre>
<p>That should do it. Now you can drag element in all browsers.</p>
<span draggable="true">I am draggable</span>
</section>

<section id="set-data">
<h2>DataTransfer object and setData method</h2>

<p>DataTransfer object is used to hold the data during drag and drop operation. Data is added to DataTransfer object using <code>setData(type, data)</code> method. This method must be called in 'dragstart' event. Data you set is protected and will only become available on 'drop' event to drop target for security reasons. It helps to prevent third-party iframes from stealing your data if you drag over them.</p>

<p>In theory, DataTransfer can hold multiple data items of various types:<p>
<pre><code>
event.dataTransfer.setData('application/json', JSON.stringify({ foo: 'bar' }));
event.dataTransfer.setData('text/plain', 'foo=bar');
</code></pre>

<p>In practice IE only supports 'text' and 'URL' for the 'type' argument. If you try setting type to something else, IE will throw an exception. The unfortunate consequence of this incompatibility is that if type of your dataTransfer is 'text', all text areas and inputs will act as drop areas by default. If you set different type, they will ignore drop event.</p>

<details>
<summary>Work around</summary>
<p>The only way to gate this is to add try-catch around <code>setData</code> and fall back to 'text', if you get an exception.</p>
<a target="_blank" href="https://connect.microsoft.com/IE/feedback/details/898860/datatransfer-setdata-type-throws-an-exception-if-type-is-anything-but-text-and-url">Issue about dataTransfer.setData in IE feedback center</a>
</details>

<div>
<span draggable="true">My data-type is 'text'</span>
<span draggable="true" data-type="application/json" data-drag-data='{"foo":"bar"}'>My data-type is 'application/json'. I don't work in IE.</span>
</div>
<textarea rows="5" placeholder="Try dragging span here"></textarea>
</section>

<section id="drag-image">
<h2>Custom drag image</h2>

<p>Another useful feature of drag and drop API is setDragImage. It allows you to use different visual representation of element that is being dragged. Despite it's name, it accepts arbitrary HTML element as an argument.</p>

<p>The only requirement is that this element must be visible to the browser when drag operation starts. Chrome and Opera won't let you use offscreen element (style.top = -1000px). But you can place drag image under the non-transparent element and it will work just fine.</p>

<div>
<span draggable="true" data-drag-image="#dragImage">I have custom dragImage. I crash IE.</span>
</div>

<p>Needless to say, that IE doesn't support that at all.</p>
<details>
<summary>Work around</summary>
<p>This problem can be worked around in IE by creating DOM element with position: fixed and moving it aroung on mousemove. You will also need to disable pointer events for drag image, otherwise it will interfere with drag events. In IE9 pointer events are supported only in SVG element, so your drag image cannot be an arbitrary element.</p>
<a target="_blank" href="https://connect.microsoft.com/IE/feedback/details/898851/datatransfer-setdragimage-is-not-working-on-drag-and-drop-events">Issue about setDragImage in IE connect center</a>
</details>
</section>
</article>

<section id="references">
<h2>References</h2>
<ol>
<li><a target="_blank" href="https://developer.mozilla.org/en-US/docs/Web/Guide/HTML/Drag_and_drop">Drag-and-drop API spec (MDN)</a></li>
<li><a target="_blank" href="http://www.html5rocks.com/en/tutorials/dnd/basics/">Tutorial on HTML5 rocks</a></li>
<li><a target="_blank" href="http://blogs.msdn.com/b/ie/archive/2011/07/27/html5-drag-and-drop-in-ie10-ppb2.aspx">Blog post about drag-and-drop on MSDN</a></li>
</ol>
</section>

<div id="dragImage" class="drag-image"></div>
</body>
</html>
